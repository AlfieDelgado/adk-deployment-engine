name: CI/CD

# NOTE: This workflow demonstrates how to use the reusable GitHub Actions workflows.
#
# === FOR THIS REPO (adk-deployment-engine) ===
# - This is the actual CI/CD workflow for testing agents-examples
# - DISABLED by default (requires ENABLE_CI_CD repository variable)
# - To enable: Settings → Secrets and variables → Actions → Variables → New repository variable
#   Name: ENABLE_CI_CD
#   Value: true
#   Name: AGENTS_DIR
#   Value: agents-examples
#
# === FOR SUBMODULE USERS ===
# - Use this as an EXAMPLE for your own ci-cd.yml
# - Copy this file to your repo: .github/workflows/ci-cd.yml
# - REMOVE or COMMENT the 'if: vars.ENABLE_CI_CD == 'true'' condition below
# - AGENTS_DIR behavior: auto-detects from Makefile, defaults to 'agents'
#   Optionally set AGENTS_DIR variable to override (e.g., for custom directory)
#
# When using as a submodule:
#   1. Change workflow references from './.github/workflows/' to 'AlfieDelgado/adk-deployment-engine/.github/workflows/@main'
#   2. Set AGENTS_DIR in your Makefile (or set as GitHub variable to override)
#   3. Ensure GCP_SA_KEY secret exists in your repository
#
# See SUBMODULE.md "Setting Up GitHub Actions" section for complete instructions.

on:
  pull_request:
    types: [closed]
    branches: [dev, stag, main]
  push:
    branches: [dev, stag, main]

permissions:
  contents: read
  pull-requests: read

jobs:
  detect:
    # Submodule users: Remove this condition to enable the workflow in your repo
    if: vars.ENABLE_CI_CD == 'true'
    uses: ./.github/workflows/detect-changes.yml
    with:
      agents-dir: ${{ vars.AGENTS_DIR || '' }}

  validate:
    needs: detect
    if: |
      vars.ENABLE_CI_CD == 'true' &&
      needs.detect.outputs.agents-to-deploy != '[]' &&
      needs.detect.outputs.agents-to-deploy != ''
    uses: ./.github/workflows/validate.yml
    with:
      agents-dir: ${{ vars.AGENTS_DIR || '' }}
      agents-to-deploy: ${{ needs.detect.outputs.agents-to-deploy }}
      branch-name: ${{ github.ref_name }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}

  deploy:
    needs: validate
    # Only run on merge or direct push AND when there are agents ready to deploy
    if: |
      vars.ENABLE_CI_CD == 'true' &&
      (github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.pull_request.merged == true)) &&
      needs.validate.outputs.ready-to-deploy != '[]' &&
      needs.validate.outputs.ready-to-deploy != ''
    uses: ./.github/workflows/deploy.yml
    with:
      agents-dir: ${{ vars.AGENTS_DIR || '' }}
      agents-to-deploy: ${{ needs.validate.outputs.ready-to-deploy }}
      branch-name: ${{ github.ref_name }}
    secrets:
      GCP_SA_KEY: ${{ secrets.GCP_SA_KEY }}
