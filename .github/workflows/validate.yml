name: Validate Agents

on:
  workflow_call:
    inputs:
      agents-dir:
        description: 'Directory containing agent configurations (if not provided, reads from Makefile AGENTS_DIR or defaults to agents)'
        required: false
        type: string
        default: ''
      agents-to-deploy:
        description: 'JSON array of agent names to validate'
        required: true
        type: string
      branch-name:
        description: 'Name of branch being deployed (dev, stag, or main)'
        required: true
        type: string
    secrets:
      GCP_SA_KEY:
        description: 'Google Cloud service account key (JSON format)'
        required: true
    outputs:
      ready-to-deploy:
        description: 'JSON array of agent names that passed validation and exist in Cloud Run'
        value: ${{ jobs.validate.outputs.ready-to-deploy }}
      needs-first-deploy:
        description: 'JSON array of agent names that dont exist in Cloud Run'
        value: ${{ jobs.validate.outputs.needs-first-deploy }}

jobs:
  validate:
    runs-on: ubuntu-latest
    outputs:
      ready-to-deploy: ${{ steps.validate.outputs.ready-to-deploy }}
      needs-first-deploy: ${{ steps.validate.outputs.needs-first-deploy }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.13'

      - name: Install yq
        run: |
          wget https://github.com/mikefarah/yq/releases/latest/download/yq_linux_amd64 -O /usr/local/bin/yq
          chmod +x /usr/local/bin/yq

      - name: Detect AGENTS_DIR from Makefile
        id: detect-agents-dir
        run: |
          if [ -n "${{ inputs.agents-dir }}" ]; then
            echo "agents-dir=${{ inputs.agents-dir }}" >> $GITHUB_OUTPUT
            echo "ðŸ“ Using provided agents-dir: ${{ inputs.agents-dir }}"
          elif [ -f "Makefile" ]; then
            MAKEFILE_AGENTS_DIR=$(grep -E '^AGENTS_DIR[[:space:]]*\\?=' Makefile | sed 's/^AGENTS_DIR[[:space:]]*[?:]=*[[:space:]]*//' | tr -d ' ')
            if [ -n "$MAKEFILE_AGENTS_DIR" ]; then
              echo "agents-dir=$MAKEFILE_AGENTS_DIR" >> $GITHUB_OUTPUT
              echo "ðŸ“ Read AGENTS_DIR from Makefile: $MAKEFILE_AGENTS_DIR"
            else
              echo "agents-dir=agents" >> $GITHUB_OUTPUT
              echo "ðŸ“ AGENTS_DIR not in Makefile, using default: agents"
            fi
          else
            echo "agents-dir=agents" >> $GITHUB_OUTPUT
            echo "ðŸ“ No Makefile found, using default: agents"
          fi

      - name: Setup environment variables
        run: |
          case "${{ inputs.branch-name }}" in
            dev)
              echo "ENVIRONMENT=dev" >> $GITHUB_ENV
              echo "PREFIX=dev-" >> $GITHUB_ENV
              ;;
            stag)
              echo "ENVIRONMENT=stag" >> $GITHUB_ENV
              echo "PREFIX=stag-" >> $GITHUB_ENV
              ;;
            main)
              echo "ENVIRONMENT=prod" >> $GITHUB_ENV
              echo "PREFIX=" >> $GITHUB_ENV
              ;;
            *)
              echo "::error::Unknown branch: ${{ inputs.branch-name }} (must be dev, stag, or main)"
              exit 1
              ;;
          esac

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Validate Agents
        id: validate
        run: |
          AGENTS_DIR="${{ steps.detect-agents-dir.outputs.agents-dir }}"

          ready=()
          needs_first=()

          for AGENT in $(echo '${{ inputs.agents-to-deploy }}' | jq -r '.[]'); do
            echo "ðŸ” Validating agent: $AGENT"
            CONFIG_FILE="$AGENTS_DIR/$AGENT/config.yaml"

            # === CHECK 1: Config File Exists ===
            if [ ! -f "$CONFIG_FILE" ]; then
              echo "::error::config.yaml not found at $CONFIG_FILE"
              exit 1
            fi

            # === CHECK 2: Validate Required Fields ===
            GCP_PROJECT=$(yq eval '.cloud_run.gcp_project // ""' "$CONFIG_FILE")
            GCP_LOCATION=$(yq eval '.cloud_run.gcp_location // ""' "$CONFIG_FILE")
            SERVICE_NAME=$(yq eval '.cloud_run.service_name // ""' "$CONFIG_FILE")

            if [ -z "$GCP_PROJECT" ]; then
              echo "::error::Missing required field: cloud_run.gcp_project"
              exit 1
            fi
            if [ -z "$GCP_LOCATION" ]; then
              echo "::error::Missing required field: cloud_run.gcp_location"
              exit 1
            fi
            if [ -z "$SERVICE_NAME" ]; then
              echo "::error::Missing required field: cloud_run.service_name"
              exit 1
            fi

            echo "âœ… Config validation passed"

            # === CHECK 3: Service Existence ===
            FINAL_SERVICE="${PREFIX}${SERVICE_NAME}"
            if gcloud run services describe "$FINAL_SERVICE" \
              --region="$GCP_LOCATION" \
              --project="$GCP_PROJECT" \
              --format='value(name)' >/dev/null 2>&1; then
              echo "âœ… Service exists: $FINAL_SERVICE"
              ready+=("$AGENT")
            else
              echo "âš ï¸  Service does NOT exist: $FINAL_SERVICE"
              needs_first+=("$AGENT")
            fi
          done

          # Output as JSON arrays (empty array if no agents)
          if [ ${#ready[@]} -eq 0 ]; then
            echo "ready-to-deploy=[]" >> $GITHUB_OUTPUT
          else
            echo "ready-to-deploy=$(printf '%s\n' "${ready[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
          fi

          if [ ${#needs_first[@]} -eq 0 ]; then
            echo "needs-first-deploy=[]" >> $GITHUB_OUTPUT
          else
            echo "needs-first-deploy=$(printf '%s\n' "${needs_first[@]}" | jq -R . | jq -s .)" >> $GITHUB_OUTPUT
          fi

      - name: Dry-run deployment
        run: |
          AGENTS_DIR="${{ steps.detect-agents-dir.outputs.agents-dir }}"

          for AGENT in $(echo '${{ inputs.agents-to-deploy }}' | jq -r '.[]'); do
            echo "ðŸ§ª Running dry-run deployment for: $AGENT"

            export GOOGLE_CLOUD_PROJECT=$(yq eval '.cloud_run.gcp_project // ""' "$AGENTS_DIR/$AGENT/config.yaml")
            export GOOGLE_CLOUD_LOCATION=$(yq eval '.cloud_run.gcp_location // ""' "$AGENTS_DIR/$AGENT/config.yaml")
            export GOOGLE_CLOUD_LOCATION_DEPLOY="$GOOGLE_CLOUD_LOCATION"
            export AGENTS_DIR="$AGENTS_DIR"

            if [ "$ENVIRONMENT" = "prod" ]; then
              python utils/deploy_agent.py --deploy "$AGENT" --dry-run || echo "::warning::Dry-run failed for $AGENT (check logs above)"
            else
              python utils/deploy_agent.py --deploy "$AGENT" --dry-run "$ENVIRONMENT" || echo "::warning::Dry-run failed for $AGENT (check logs above)"
            fi
          done

      - name: Generate summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'SUMMARY'
          ### ðŸ“‹ Validation Results

          | Status | Agents |
          |--------|--------|
          | âœ… Ready to Deploy | ${{ steps.validate.outputs.ready-to-deploy }} |
          | âš ï¸ Needs First Deployment | ${{ steps.validate.outputs.needs-first-deploy }} |

          SUMMARY
